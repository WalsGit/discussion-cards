(()=>{var s={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return s.d(a,{a}),a},d:(t,a)=>{for(var i in a)s.o(a,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:a[i]})},o:(s,t)=>Object.prototype.hasOwnProperty.call(s,t)};(()=>{"use strict";const t=flarum.core.compat.app;var a=s.n(t);const i=flarum.core.compat.extend,e=flarum.core.compat["forum/components/DiscussionList"];var r=s.n(e);const o=flarum.core.compat["forum/states/DiscussionListState"];var n=s.n(o);const c=flarum.core.compat["forum/components/IndexPage"];var l=s.n(c);const u=flarum.core.compat["common/components/LoadingIndicator"];var d=s.n(u);const p=flarum.core.compat["common/components/Placeholder"];var f=s.n(p);const g=flarum.core.compat["common/components/Button"];var v=s.n(g);function h(s,t){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,t){return s.__proto__=t,s},h(s,t)}function N(s,t){s.prototype=Object.create(t.prototype),s.prototype.constructor=s,h(s,t)}const w=flarum.core.compat["common/Component"];var b=s.n(w);const C=flarum.core.compat["common/helpers/icon"];var y=s.n(C);const I=flarum.core.compat["common/components/Tooltip"];var D=s.n(I);function L(s){if(s.length)return[m(".cardBadges",[s.map((function(s){return[m(D(),{text:s.attrs.label[0],position:"right"},m("span.cardBadge.Badge.Badge--"+s.attrs.type,[y()(s.attrs.icon)]))]}))])]}function P(s,t,a){void 0===a&&(a=1);var i=t,e=app.forum.attribute("baseUrl")+"/assets/"+i;if(s){var r=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>/.exec(s.contentHtml());return"number"==typeof a&&a>0?r?r[a]:i?e:null:"~"===a?r:null}}const A=flarum.core.compat["common/components/Link"];var T=s.n(A);const S=flarum.core.compat["tags/utils/sortTags"];var x=s.n(S);function O(s){if(s)return[x()(s).map((function(s){return[m(T(),{className:"cardTag",style:{backgroundColor:s.color()},href:app.route("tag",{tags:s.slug()})},s.name())]}))]}const B=flarum.core.compat["common/utils/humanTime"];var R=s.n(B);const _=flarum.core.compat["common/helpers/username"];var k=s.n(_);const j=flarum.core.compat["common/components/Dropdown"];var H=s.n(j);const W=flarum.core.compat["forum/utils/DiscussionControls"];var V=s.n(W);const z=flarum.core.compat["common/utils/string"],J=flarum.core.compat["common/helpers/avatar"];var F=s.n(J),M=function(s){function t(){return s.apply(this,arguments)||this}N(t,s);var a=t.prototype;return a.oninit=function(t){s.prototype.oninit.call(this,t),this.discussion=this.attrs.discussion},a.view=function(){return this.discussion.posts().splice(-10).filter((function(s){return!s.isHidden()&&1!==s.number()&&"comment"===s.contentType()})).sort((function(s,t){return t.createdAt()-s.createdAt()})).map((function(s){return s.user()})).filter((function(s,t,a){return a.indexOf(s)===t})).reverse().splice(-3).map((function(s){return F()(s,{className:"Avatar--mini"})}))},t}(b());function q(s,t){return s.isChild&&!t.isChild?-1:!s.isChild&&t.isChild?1:s.isChild&&t.isChild&&s.parent===t.parent?s.position-t.position:s.isChild&&t.isChild&&s.parent!==t.parent?s.parent-t.parent:!s.position&&t.position?1:s.position&&!t.position?-1:s.position&&t.position?s.position-t.position:s.id-t.id}var E=function(s){function t(){return s.apply(this,arguments)||this}N(t,s);var a=t.prototype;return a.oninit=function(t){s.prototype.oninit.call(this,t),this.discussion=this.attrs.discussion},a.view=function(){var s=this.discussion,t={};for(var a in app.forum.data.attributes)if(a.startsWith("walsgitDiscussionCards")){var i=a.replace("walsgitDiscussionCards","");t[i=i.replace(/^./,i.charAt(0).toLowerCase())]=app.forum.data.attributes[a]}var e,r=m.route.get().split("?")[0].startsWith("/t/");if(r){var o,n=null==(o=m.route.get().split("/t/")[1])?void 0:o.split("?")[0];e=app.store.all("tags").find((function(s){return s.slug()===n})).data.id;var c=app.store.all("tags").find((function(s){return s.id()===e})),l=c?JSON.parse(c.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},u=c?c.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var d in l.defaultImage=u,l)t.hasOwnProperty(d)&&l[d]!==t[d]&&null!==l[d]&&(t[d]=l[d])}if("/"===m.route.get().split("?")[0]){var p=s.tags();for(var f in p){var g=p[f].id(),v=p[f].isChild(),h=p[f].data.hasOwnProperty("relationships")&&p[f].parent()?p[f].parent().data.id:null,N=p[f].position(),w=p[f].attribute("walsgitDiscussionCardsTagDefaultImage"),b={id:g,isChild:v,parent:h,position:N,tagCustomImg:w},C=null;t.allowedTags.includes(g)&&null!==w&&(null===C||q(b,C)<0)&&(C={id:g,isChild:v,parent:h,position:N,tagCustomImg:w},t.defaultImage=w)}}var I=1===Number(t.markReadCards)&&s.isRead()&&app.session.user?"read":"",D={};D.className="wrapImg"+(1===Number(t.showAuthor)?" After":"");var A=P(s.firstPost(),t.defaultImage),S=A?m("img",{src:A,className:"previewCardImg",alt:s.title(),loading:"lazy"}):m("div",{className:"imgStub"});return m("div",{key:s.id(),"data-id":s.id(),"data-tag-id":r?e:null,className:"CardsListItem Card "+I+(s.isHidden()?" Hidden":"")},V().controls(s,this).toArray().length?m(H(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},V().controls(s,this).toArray()):"",m(T(),{href:app.route.discussion(s,0),className:"cardLink"},1===Number(t.showBadges)?L(s.badges().toArray()):"",m("div",D,1!==Number(t.showViews)||isNaN(s.views())?"":m("div",{className:"imageLabel discussionViews"},y()("fas fa-eye",{className:"labelIcon"}),s.views()),S,1===Number(t.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},k()(s.user())),m("div",{className:"Date"},R()(s.createdAt()))):""),m("div",{className:"cardTags"},O(s.tags())),m("div",{className:"cardTitle"},m("h2",null,s.title())),1===Number(t.previewText)&&s.firstPost()?m("div",{className:"previewPost"},(0,z.truncate)(s.firstPost().contentPlain(),150)):"",1===Number(t.showReplies)?m("div",{className:"cardSpacer"},m(T(),{className:"Replies",href:app.route.discussion(s,s.lastPostNumber())},m("div",{className:"Left"},m("div",{className:"Avatars"},m(M,{discussion:s})),m("div",{className:"Repcount"},app.translator.trans("walsgit_discussion_cards.forum.replies",{count:s.replyCount()||"0"}))),m("div",{className:"Arrow"},y()("fas fa-angle-right")))):""))},t}(b()),G=function(s){function t(){return s.apply(this,arguments)||this}N(t,s);var a=t.prototype;return a.oninit=function(t){s.prototype.oninit.call(this,t)},a.view=function(){var s=this.attrs.discussion,t={};for(var a in app.forum.data.attributes)if(a.startsWith("walsgitDiscussionCards")){var i=a.replace("walsgitDiscussionCards","");t[i=i.replace(/^./,i.charAt(0).toLowerCase())]=app.forum.data.attributes[a]}if(m.route.get().split("?")[0].startsWith("/t/")){var e,r=null==(e=m.route.get().split("/t/")[1])?void 0:e.split("?")[0],o=app.store.all("tags").find((function(s){return s.slug()===r})).data.id,n=app.store.all("tags").find((function(s){return s.id()===o})),c=n?JSON.parse(n.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},l=n?n.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var u in c.defaultImage=l,c)t.hasOwnProperty(u)&&c[u]!==t[u]&&null!==c[u]&&(t[u]=c[u])}if("/"===m.route.get().split("?")[0]){var d=s.tags();for(var p in d){var f=d[p].id(),g=d[p].isChild(),v=d[p].data.hasOwnProperty("relationships")&&d[p].parent()?d[p].parent().data.id:null,h=d[p].position(),N=d[p].attribute("walsgitDiscussionCardsTagDefaultImage"),w={id:f,isChild:g,parent:v,position:h,tagCustomImg:N},b=null;t.allowedTags.includes(f)&&null!==N&&(null===b||q(w,b)<0)&&(b={id:f,isChild:g,parent:v,position:h,tagCustomImg:N},t.defaultImage=N)}}var C=1===Number(t.markReadCards)&&s.isRead()&&app.session.user?"read":"",I={};I.className="wrapImg"+(1===Number(t.showAuthor)?" After":"");var D=P(s.firstPost(),t.defaultImage),A=D?m("img",{src:D,className:"previewCardImg",alt:s.title(),loading:"lazy"}):m("div",{className:"imgStub"});return m("div",{key:s.id(),"data-id":s.id(),className:"CardsListItem List "+C+(s.isHidden()?" Hidden":"")},V().controls(s,this).toArray().length?m(H(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},V().controls(s,this).toArray()):"",m(T(),{href:app.route.discussion(s,0),className:"cardLink"},1===Number(t.showBadges)?L(s.badges().toArray()):"",m("div",{className:"cardGrid"},m("div",{className:"rowSpan-3 colSpan"},m("div",I,1!==Number(t.showViews)||isNaN(s.views())?"":m("div",{className:"imageLabel discussionViews"},y()("fas fa-eye",{className:"labelIcon"}),s.views()),A,1===Number(t.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},k()(s.user())),m("div",{className:"Date"},R()(s.createdAt()))):"")),m("div",{className:"rowSpan-3 colSpan-2"},m("div",{className:"flexBox"},m("div",{className:"cardTitle"},m("h2",{title:s.title(),className:"title"},(0,z.truncate)(s.title(),80))),m("div",{className:"cardTags"},O(s.tags()))),1===Number(t.previewText)&&s.firstPost()?m("div",{className:"previewPost"},(0,z.truncate)(s.firstPost().contentPlain(),150)):"","phone"===app.screen()&&1===Number(t.showReplies)?m("div",{className:"cardSpacer"},m(T(),{className:"Replies",href:app.route.discussion(s,s.lastPostNumber())},m("div",{className:"Left"},m("div",{className:"Avatars"},m(M,{discussion:s})),m("div",{className:"Repcount"},app.translator.trans("walsgit_discussion_cards.forum.replies",{count:s.replyCount()||"0"}))),m("div",{className:"Arrow"},y()("fas fa-angle-right")))):1===Number(t.showReplies)?m("div",{className:"imageLabel discussionReplyCount"},y()("fas fa-comment",{className:"labelIcon"}),s.replyCount()):""))))},t}(b());const U={"walsgit/discussion/cards/components/CardItem":E,"walsgit/discussion/cards/components/ListItem":G,"walsgit/discussion/cards/components/LastReplies":M,"walsgit/discussion/cards/utils/craftTags":O,"walsgit/discussion/cards/utils/craftBadges":L},K=flarum.core;a().initializers.add("walsgit/discussion/cards",(function(){(0,i.extend)(n().prototype,"requestParams",(function(s){a().current.matches(l())&&s.include.push(["firstPost","posts","posts.user"])})),(0,i.override)(r().prototype,"view",(function(s){var t={};for(var i in a().forum.data.attributes)if(i.startsWith("walsgitDiscussionCards")){var e=i.replace("walsgitDiscussionCards","");e=e.replace(/^./,e.charAt(0).toLowerCase()),t[e]=a().forum.data.attributes[i]}var r,o=this.attrs.state,n=o.getParams();if(o.isInitialLoading()||o.isLoadingNext()?r=m(d(),null):o.hasNext()&&(r=v().component({className:"Button",onclick:o.loadNext.bind(o)},a().translator.trans("core.forum.discussion_list.load_more_button"))),o.isEmpty()){var c=a().translator.trans("core.forum.discussion_list.empty_text");return m("div",{className:"DiscussionList"},m(f(),{text:c}))}var u=null;if(m.route.get().split("?")[0].startsWith("/t/")){u=a().store.all("tags").find((function(s){return s.slug()===n.tags})).data.id;var p=JSON.parse(a().store.all("tags").find((function(s){return s.slug()===n.tags})).data.attributes.walsgitDiscussionCardsTagSettings);for(var g in p)t.hasOwnProperty(g)&&p[g]!==t[g]&&(t[g]=p[g])}return a().current.matches(l())&&(t.allowedTags.length&&t.allowedTags.includes(u)||!n.tags&&1===Number(t.onIndexPage))?m("div",{className:"DiscussionList"+(o.isSearchResults()?" DiscussionList--searchResults":"")},m("div",{class:"DiscussionList-discussions flexCard"},o.getPages().map((function(s,a){return s.items.map((function(s,i){return i<Number(t.primaryCards)&&0===a?m(E,{discussion:s}):m(G,{discussion:s})}))}))),m("div",{className:"DiscussionList-loadMore"},r)):s()}))}),-1),Object.assign(K.compat,U)})(),module.exports={}})();
//# sourceMappingURL=forum.js.map