(()=>{var t={n:a=>{var s=a&&a.__esModule?()=>a.default:()=>a;return t.d(s,{a:s}),s},d:(a,s)=>{for(var e in s)t.o(s,e)&&!t.o(a,e)&&Object.defineProperty(a,e,{enumerable:!0,get:s[e]})},o:(t,a)=>Object.prototype.hasOwnProperty.call(t,a)};(()=>{"use strict";const a=flarum.core.compat.app;var s=t.n(a);const e=flarum.core.compat.extend,r=flarum.core.compat["forum/components/DiscussionList"];var i=t.n(r);const o=flarum.core.compat["forum/states/DiscussionListState"];var n=t.n(o);const l=flarum.core.compat["forum/components/IndexPage"];var u=t.n(l);const c=flarum.core.compat["common/components/LoadingIndicator"];var d=t.n(c);const p=flarum.core.compat["common/components/Placeholder"];var g=t.n(p);const f=flarum.core.compat["common/components/Button"];var v=t.n(f);function h(t,a){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,a){return t.__proto__=a,t},h(t,a)}function b(t,a){t.prototype=Object.create(a.prototype),t.prototype.constructor=t,h(t,a)}const N=flarum.core.compat["common/Component"];var w=t.n(N);const y=flarum.core.compat["common/helpers/icon"];var I=t.n(y);const C=flarum.core.compat["common/components/Tooltip"];var P=t.n(C);function L(t){if(t.length)return[m(".cardBadges",[t.map((function(t){return[m(P(),{text:t.attrs.label[0],position:"right"},m("span.cardBadge.Badge.Badge--"+t.attrs.type,[I()(t.attrs.icon)]))]}))])]}function D(t){if("string"!=typeof t)return!1;var a;t.startsWith("http://")||t.startsWith("https://")||(t="http://"+t);try{a=new URL(t)}catch(t){return!1}var s=a.pathname.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","svg"].includes(s)}function T(t,a,s,e){if(void 0===s&&(s=!1),void 0===e&&(e=1),s&&D(a))return a;var r=app.forum.attribute("baseUrl")+"/assets/"+a;if(t){var i=/<img(?!.*?class="emoji").*?src=[\'"](.*?)[\'"].*?>|background(?:-image)?:\s*url\(['"]?(.*?)['"]?\)/i.exec(t.contentHtml());return"number"==typeof e&&e>0?i?i[1]||i[2]:a?r:null:"~"===e?i:null}}const A=flarum.core.compat["common/components/Link"];var O=t.n(A);const S=flarum.core.compat["tags/utils/sortTags"];var x=t.n(S);function B(t){if(t)return[x()(t).map((function(t){return[m(O(),{className:"cardTag",style:{backgroundColor:t.color()},href:app.route("tag",{tags:t.slug()})},t.name())]}))]}const R=flarum.core.compat["common/utils/humanTime"];var _=t.n(R);const k=flarum.core.compat["common/helpers/username"];var M=t.n(k);const W=flarum.core.compat["common/components/Dropdown"];var j=t.n(W);const H=flarum.core.compat["forum/utils/DiscussionControls"];var q=t.n(H);const V=flarum.core.compat["common/utils/string"],z=flarum.core.compat["common/helpers/avatar"];var E=t.n(z),J=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){return this.discussion.posts().splice(-10).filter((function(t){return!t.isHidden()&&1!==t.number()&&"comment"===t.contentType()})).sort((function(t,a){return a.createdAt()-t.createdAt()})).map((function(t){return t.user()})).filter((function(t,a,s){return s.indexOf(t)===a})).reverse().splice(-3).map((function(t){return E()(t,{className:"Avatar--mini"})}))},a}(w());function F(t,a){return t.isChild&&!a.isChild?-1:!t.isChild&&a.isChild?1:t.isChild&&a.isChild&&t.parent===a.parent?t.position-a.position:t.isChild&&a.isChild&&t.parent!==a.parent?t.parent-a.parent:!t.position&&a.position?1:t.position&&!a.position?-1:t.position&&a.position?t.position-a.position:t.id-a.id}const G=flarum.core.compat["components/TerminalPost"];var U=t.n(G),K=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a),this.discussion=this.attrs.discussion},s.view=function(){var t=this.discussion,a={};for(var s in app.forum.data.attributes)if(s.startsWith("walsgitDiscussionCards")){var e=s.replace("walsgitDiscussionCards","");a[e=e.replace(/^./,e.charAt(0).toLowerCase())]=app.forum.data.attributes[s]}var r=app.forum.data.attributes.hasOwnProperty("blogTags"),i={},o=t.data.relationships.hasOwnProperty("blogMeta"),n={};if(r&&(i.tags=app.forum.attribute("blogTags"),i.defaultImage=app.forum.attribute("blogDefaultImage"),o)){var l=t.store.data.blogMeta[t.data.relationships.blogMeta.data.id];D(l.attribute("featuredImage"))&&(n.featuredImage=l.attribute("featuredImage"))}var u,c="shebaoting-repost"in flarum.extensions,d=t.data.attributes.original_url||null,p=m.route.get().split("?")[0].startsWith("/t/");if(p){var g,f=null==(g=m.route.get().split("/t/")[1])?void 0:g.split("?")[0];u=app.store.all("tags").find((function(t){return t.slug()===f})).data.id;var v=app.store.all("tags").find((function(t){return t.id()===u})),h=v?JSON.parse(v.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},b=v?v.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var N in h.defaultImage=b,r&&1===Number(a.useBlogImages)&&i.tags.includes(u)&&(h.defaultImage=o&&n.featuredImage&&D(n.featuredImage)?n.featuredImage:i.defaultImage),h)a.hasOwnProperty(N)&&h[N]!==a[N]&&null!==h[N]&&(a[N]=h[N])}if("/"===m.route.get().split("?")[0]){var w=t.tags();for(var y in w){var C=w[y].id(),P=w[y].isChild(),A=w[y].data.hasOwnProperty("relationships")&&w[y].parent()?w[y].parent().data.id:null,S=w[y].position(),x=w[y].attribute("walsgitDiscussionCardsTagDefaultImage");r&&1===Number(a.useBlogImages)&&i.tags.includes(C)&&(x=o&&n.featuredImage&&D(n.featuredImage)?n.featuredImage:i.defaultImage);var R={id:C,isChild:P,parent:A,position:S,tagCustomImg:x},k=null;a.allowedTags.includes(C)&&null!==x&&(null===k||F(R,k)<0)&&(k={id:C,isChild:P,parent:A,position:S,tagCustomImg:x},a.defaultImage=x)}}var W=1===Number(a.markReadCards)&&t.isRead()&&app.session.user?"read":"",H={};H.className="wrapImg"+(1===Number(a.showAuthor)?" After":"");var z=T(t.firstPost(),a.defaultImage,o),E=z?m("img",{src:z,className:"previewCardImg",alt:t.title(),loading:"lazy"}):m("div",{className:"imgStub"});return m("div",{key:t.id(),"data-id":t.id(),"data-tag-id":p?u:null,className:"CardsListItem Card "+W+(t.isHidden()?" Hidden":"")},q().controls(t,this).toArray().length?m(j(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},q().controls(t,this).toArray()):"",m(O(),{href:app.route.discussion(t,0),className:"cardLink"},1===Number(a.showBadges)?L(t.badges().toArray()):"",m("div",H,t.data.attributes.hasOwnProperty("views")&&m("[",null,1!==Number(a.showViews)||isNaN(t.views())?"":m("div",{className:"imageLabel discussionViews"},I()("fas fa-eye",{className:"labelIcon"}),t.views())),E,1===Number(a.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},M()(t.user())),m("div",{className:"Date"},_()(t.createdAt()))):""),m("div",{className:"cardTags"},B(t.tags())),m("div",{className:"cardTitle"},m("h2",{title:t.title(),className:"title"},1===Number(a.allowRepostLinks)&&c&&d?m("a",{href:d,onclick:function(t){return t.stopPropagation()}},(0,V.truncate)(t.title(),80)):(0,V.truncate)(t.title(),80))),1===Number(a.previewText)&&t.firstPost()?m("div",{className:"previewPost"},r&&1===Number(a.useBlogSummary)&&t.data.relationships.hasOwnProperty("blogMeta")&&""!==t.blogMeta().summary()?(0,V.truncate)(t.blogMeta().summary(),150):(0,V.truncate)(t.firstPost().contentPlain(),150)):"",1===Number(a.showLastPostInfo)&&t.firstPost()?m("div",{className:"terminalPost"},m(U(),{discussion:t,lastPost:t.lastPostNumber()})):"",1===Number(a.showReplies)?m("div",{className:"cardSpacer"},m(O(),{className:"Replies",href:app.route.discussion(t,t.lastPostNumber())},m("div",{className:"Left"},m("div",{className:"Avatars"},m(J,{discussion:t})),m("div",{className:"Repcount"},app.translator.trans("walsgit_discussion_cards.forum.replies",{count:t.replyCount()||"0"}))),m("div",{className:"Arrow"},I()("fas fa-angle-right")))):""))},a}(w());const Q=flarum.core.compat["common/utils/abbreviateNumber"];var X=t.n(Q),Y=function(t){function a(){return t.apply(this,arguments)||this}b(a,t);var s=a.prototype;return s.oninit=function(a){t.prototype.oninit.call(this,a)},s.view=function(){var t=this.attrs.discussion,a={};for(var s in app.forum.data.attributes)if(s.startsWith("walsgitDiscussionCards")){var e=s.replace("walsgitDiscussionCards","");a[e=e.replace(/^./,e.charAt(0).toLowerCase())]=app.forum.data.attributes[s]}var r=app.forum.data.attributes.hasOwnProperty("blogTags"),i={},o=t.data.relationships.hasOwnProperty("blogMeta"),n={};if(r&&(i.tags=app.forum.attribute("blogTags"),i.defaultImage=app.forum.attribute("blogDefaultImage"),o)){var l=t.store.data.blogMeta[t.data.relationships.blogMeta.data.id];D(l.attribute("featuredImage"))&&(n.featuredImage=l.attribute("featuredImage"))}var u="shebaoting-repost"in flarum.extensions,c=t.data.attributes.original_url||null;if(m.route.get().split("?")[0].startsWith("/t/")){var d,p=null==(d=m.route.get().split("/t/")[1])?void 0:d.split("?")[0],g=app.store.all("tags").find((function(t){return t.slug()===p})).data.id,f=app.store.all("tags").find((function(t){return t.id()===g})),v=f?JSON.parse(f.data.attributes.walsgitDiscussionCardsTagSettings||"{}"):{},h=f?f.data.attributes.walsgitDiscussionCardsTagDefaultImage:null;for(var b in v.defaultImage=h,r&&1===Number(a.useBlogImages)&&i.tags.includes(g)&&(v.defaultImage=o&&n.featuredImage&&D(n.featuredImage)?n.featuredImage:i.defaultImage),v)a.hasOwnProperty(b)&&v[b]!==a[b]&&null!==v[b]&&(a[b]=v[b])}if("/"===m.route.get().split("?")[0]){var N=t.tags();for(var w in N){var y=N[w].id(),C=N[w].isChild(),P=N[w].data.hasOwnProperty("relationships")&&N[w].parent()?N[w].parent().data.id:null,A=N[w].position(),S=N[w].attribute("walsgitDiscussionCardsTagDefaultImage");r&&1===Number(a.useBlogImages)&&i.tags.includes(y)&&(S=o&&n.featuredImage&&D(n.featuredImage)?n.featuredImage:i.defaultImage);var x={id:y,isChild:C,parent:P,position:A,tagCustomImg:S},R=null;a.allowedTags.includes(y)&&null!==S&&(null===R||F(x,R)<0)&&(R={id:y,isChild:C,parent:P,position:A,tagCustomImg:S},a.defaultImage=S)}}var k=1===Number(a.markReadCards)&&t.isRead()&&app.session.user?"read":"",W={};W.className="wrapImg"+(1===Number(a.showAuthor)?" After":"");var H=T(t.firstPost(),a.defaultImage,o),z=H?m("img",{src:H,className:"previewCardImg",alt:t.title(),loading:"lazy"}):m("div",{className:"imgStub"});return m("div",{key:t.id(),"data-id":t.id(),className:"CardsListItem List "+k+(t.isHidden()?" Hidden":"")},q().controls(t,this).toArray().length?m(j(),{icon:"fas fa-ellipsis-v",className:"DiscussionListItem-controls",buttonClassName:"Button Button--icon Button--flat Slidable-underneath Slidable-underneath--right"},q().controls(t,this).toArray()):"",m(O(),{href:app.route.discussion(t,0),className:"cardLink"},1===Number(a.showBadges)?L(t.badges().toArray()):"",m("div",{className:"cardGrid"},m("div",{className:"rowSpan-3 colSpan"},m("div",W,t.data.attributes.hasOwnProperty("views")&&m("[",null,1!==Number(a.showViews)||isNaN(t.views())?"":m("div",{className:"imageLabel discussionViews"},I()("fas fa-eye",{className:"labelIcon"}),t.views())),z,1===Number(a.showAuthor)?m("div",{className:"cardFoot"},m("div",{className:"Author"},M()(t.user())),m("div",{className:"Date"},_()(t.createdAt()))):"")),m("div",{className:"rowSpan-3 colSpan-2"},m("div",{className:"flexBox"},m("div",{className:"cardTitle"},m("h2",{title:t.title(),className:"title"},1===Number(a.allowRepostLinks)&&u&&c?m("a",{href:c,onclick:function(t){return t.stopPropagation()}},(0,V.truncate)(t.title(),80)):(0,V.truncate)(t.title(),80)),"phone"!==app.screen()&&1===Number(a.showReplies)&&1===Number(a.showRepliesOnRight)?m("div",{className:"DiscussionListItem-count"},m("span",{"aria-hidden":"true"},X()(t.replyCount())),m("span",{className:"visually-hidden"},app.translator.trans("core.forum.discussion_list.unread_replies_a11y_label",{count:t.replyCount()}))):""),m("div",{className:"cardTags"},B(t.tags()))),1===Number(a.previewText)&&t.firstPost()?m("div",{className:"previewPost"},r&&1===Number(a.useBlogSummary)&&t.data.relationships.hasOwnProperty("blogMeta")&&""!==t.blogMeta().summary()?(0,V.truncate)(t.blogMeta().summary(),150):(0,V.truncate)(t.firstPost().contentPlain(),150)):"",1===Number(a.showLastPostInfo)&&t.firstPost()?m("div",{className:"terminalPost"},m(U(),{discussion:t,lastPost:t.lastPostNumber()})):"","phone"===app.screen()&&1===Number(a.showReplies)?m("div",{className:"cardSpacer"},m(O(),{className:"Replies",href:app.route.discussion(t,t.lastPostNumber())},m("div",{className:"Left"},m("div",{className:"Avatars"},m(J,{discussion:t})),m("div",{className:"Repcount"},app.translator.trans("walsgit_discussion_cards.forum.replies",{count:t.replyCount()||"0"}))),m("div",{className:"Arrow"},I()("fas fa-angle-right")))):1!==Number(a.showReplies)||Number(a.showRepliesOnRight)?"":m("div",{className:"imageLabel discussionReplyCount"},I()("fas fa-comment",{className:"labelIcon"}),t.replyCount())))))},a}(w());function Z(){var t=document.querySelectorAll(".CardsListItem.Card .cardLink"),a=document.querySelectorAll(".cardGrid .colSpan-2"),s=function(t,a){t&&(t.scrollWidth>a.clientWidth-30?t.classList.add("overflowing"):t.classList.remove("overflowing"))};t.forEach((function(t){var a=t.querySelector(".cardTags");s(a,t)})),a.forEach((function(t){var a=t.querySelector(".flexBox .cardTags");s(a,t)}))}const $={"walsgit/discussion/cards/components/CardItem":K,"walsgit/discussion/cards/components/ListItem":Y,"walsgit/discussion/cards/components/LastReplies":J,"walsgit/discussion/cards/utils/craftTags":B,"walsgit/discussion/cards/utils/craftBadges":L},tt=flarum.core;s().initializers.add("walsgit/discussion/cards",(function(){(0,e.extend)(i().prototype,"oncreate",Z),(0,e.extend)(i().prototype,"onupdate",Z),(0,e.extend)(n().prototype,"requestParams",(function(t){s().current.matches(u())&&t.include.push(["firstPost","posts","posts.user"])})),(0,e.override)(i().prototype,"view",(function(t){var a={};for(var e in s().forum.data.attributes)if(e.startsWith("walsgitDiscussionCards")){var r=e.replace("walsgitDiscussionCards","");r=r.replace(/^./,r.charAt(0).toLowerCase()),a[r]=s().forum.data.attributes[e]}var i,o=this.attrs.state,n=o.getParams();if(o.isInitialLoading()||o.isLoadingNext()?i=m(d(),null):o.hasNext()&&(i=v().component({className:"Button",onclick:o.loadNext.bind(o)},s().translator.trans("core.forum.discussion_list.load_more_button"))),o.isEmpty()){var l=s().translator.trans("core.forum.discussion_list.empty_text");return m("div",{className:"DiscussionList"},m(g(),{text:l}))}var c=null;if(m.route.get().split("?")[0].startsWith("/t/")){c=s().store.all("tags").find((function(t){return t.slug()===n.tags})).data.id;var p=JSON.parse(s().store.all("tags").find((function(t){return t.slug()===n.tags})).data.attributes.walsgitDiscussionCardsTagSettings);for(var f in p)a.hasOwnProperty(f)&&p[f]!==a[f]&&(a[f]=p[f])}return s().current.matches(u())&&(a.allowedTags.length&&a.allowedTags.includes(c)||!n.tags&&1===Number(a.onIndexPage))?m("div",{className:"DiscussionList"+(o.isSearchResults()?" DiscussionList--searchResults":"")},m("div",{class:"DiscussionList-discussions flexCard"},o.getPages().map((function(t,s){return t.items.map((function(t,e){return e<Number(a.primaryCards)&&0===s?m(K,{discussion:t}):m(Y,{discussion:t})}))}))),m("div",{className:"DiscussionList-loadMore"},i)):t()}))}),-1),Object.assign(tt.compat,$)})(),module.exports={}})();
//# sourceMappingURL=forum.js.map